xl.workbook.close()
}
P20main <- read.csv("~/Poverty data/P20incometrends20180608.csv")
P20main$Consumption=NA
P20main$Consumption[which(P20main$DataType==0)]="Consumption"
P20main$Consumption[which(P20main$DataType==1)]="Income"
keep=c("CountryName","P20average","restaverage","P20Headcount","P20pop","restpop","ExtPovHC","RequestYear","RegionCID","Consumption","NP20average","Nrestaverage" )
P20main2=P20main[,keep]
names(P20main2)[which(names(P20main2)=="P20Headcount")] <- "Percent.in.P20"
names(P20main2)[which(names(P20main2)=="ExtPovHC")] <- "Percent.in.Extreme.Poverty"
names(P20main2)[which(names(P20main2)=="RequestYear")] <- "Year"
regions=unique(P20main$RegionCID)
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/P20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","P20average","restaverage","Year")]
names(new)=c("CountryName","P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/NP20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","NP20average","Nrestaverage","Year")]
names(new)=c("CountryName","National P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
# p=ggplot(data=new, aes(x=Year, y=Nrestaverage))+ geom_line(aes(y=NP20average, colour="National P20"))+ geom_line(aes(y=Nrestaverage, colour="Rest"))+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year")+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
P20main <- read.csv("~/Poverty data/P20incometrends20180608.csv")
P20main$Consumption=NA
P20main$Consumption[which(P20main$DataType==0)]="Consumption"
P20main$Consumption[which(P20main$DataType==1)]="Income"
keep=c("CountryName","P20average","restaverage","P20Headcount","P20pop","restpop","ExtPovHC","RequestYear","RegionCID","Consumption","NP20average","Nrestaverage" )
P20main2=P20main[,keep]
names(P20main2)[which(names(P20main2)=="P20Headcount")] <- "Percent.in.P20"
names(P20main2)[which(names(P20main2)=="ExtPovHC")] <- "Percent.in.Extreme.Poverty"
names(P20main2)[which(names(P20main2)=="RequestYear")] <- "Year"
regions=unique(P20main$RegionCID)
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/P20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","P20average","restaverage","Year")]
names(new)=c("CountryName","P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/NP20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","NP20average","Nrestaverage","Year")]
names(new)=c("CountryName","National P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
# p=ggplot(data=new, aes(x=Year, y=Nrestaverage))+ geom_line(aes(y=NP20average, colour="National P20"))+ geom_line(aes(y=Nrestaverage, colour="Rest"))+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year")+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
# p=ggplot(data=new, aes(x=Year, y=Nrestaverage))+ geom_line(aes(y=NP20average, colour="National P20"))+ geom_line(aes(y=Nrestaverage, colour="Rest"))+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year")+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)
print(p)
P20main <- read.csv("~/Poverty data/P20incometrends20180608.csv")
P20main$Consumption=NA
P20main$Consumption[which(P20main$DataType==0)]="Consumption"
P20main$Consumption[which(P20main$DataType==1)]="Income"
keep=c("CountryName","RequestYear","P20average","restaverage","P20Headcount","P20pop","restpop","ExtPovHC","RegionCID","Consumption","NP20average","Nrestaverage" )
P20main2=P20main[,keep]
names(P20main2)[which(names(P20main2)=="P20Headcount")] <- "Percent.in.P20"
names(P20main2)[which(names(P20main2)=="ExtPovHC")] <- "Percent.in.Extreme.Poverty"
names(P20main2)[which(names(P20main2)=="RequestYear")] <- "Year"
regions=unique(P20main$RegionCID)
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/P20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","P20average","restaverage","Year")]
names(new)=c("CountryName","P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)+ scale_y_continuous(y=0)
print(p)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)+ scale_y_continuous(expand=0)
print(p)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)+ scale_y_continuous(expand=c(0,0))
print(p)
P20main <- read.csv("~/Poverty data/P20incometrends20180608.csv")
P20main$Consumption=NA
P20main$Consumption[which(P20main$DataType==0)]="Consumption"
P20main$Consumption[which(P20main$DataType==1)]="Income"
keep=c("CountryName","RequestYear","P20average","restaverage","P20Headcount","P20pop","restpop","ExtPovHC","RegionCID","Consumption","NP20average","Nrestaverage" )
P20main2=P20main[,keep]
names(P20main2)[which(names(P20main2)=="P20Headcount")] <- "Percent.in.P20"
names(P20main2)[which(names(P20main2)=="ExtPovHC")] <- "Percent.in.Extreme.Poverty"
names(P20main2)[which(names(P20main2)=="RequestYear")] <- "Year"
regions=unique(P20main$RegionCID)
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/P20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","P20average","restaverage","Year")]
names(new)=c("CountryName","P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)+ scale_y_continuous(expand=c(0,0))
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
for(region in regions){
print(region)
filenam=paste0("C:/Users/Zach/Documents/P20 Analysis 2018/Income comparisons P20 and rest/NP20versusRestIncomeTrends20180602",region,".xlsx")
P20main3=subset(P20main2, RegionCID==region)
xl.workbook.add()
countries=unique(P20main3$CountryName)
for(country in countries){
new=subset(P20main3, CountryName==country)
Consumption=unique(new$Consumption)
new=new[,c("CountryName","NP20average","Nrestaverage","Year")]
names(new)=c("CountryName","National P20","Rest of population","Year")
new.m=melt(new,id.vars=c("CountryName","Year"))
title=paste(country, "\n",Consumption,"Trends")
# p=ggplot(data=new, aes(x=Year, y=Nrestaverage))+ geom_line(aes(y=NP20average, colour="National P20"))+ geom_line(aes(y=Nrestaverage, colour="Rest"))+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year")+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)
p=ggplot(data=new.m, aes(x=Year, y=value,group=variable,colour=variable))+geom_line()+labs(title=title,y=paste("Average daily", str_to_lower(Consumption), "per person\nUSD 2011 PPP"),x="Year",colour="")+theme_classic()+theme(legend.title=element_blank(), plot.title=element_text(hjust=0.5))+scale_y_continuous(labels=dollar)+expand_limits(y=0)+ scale_y_continuous(expand=c(0,0))
print(p)
y.plot=current.graphics()
xl.sheet.add(substr(country,1,30))
xl[a1]=y.plot
xl[i1]=t(names(new))
xl[i2]=new
}
xl.sheet.delete("Sheet1")
xl.sheet.delete("Sheet2")
xl.sheet.delete("Sheet3")
xl.workbook.save(filenam)
xl.workbook.close()
}
list.of.packages <- c("readr","data.table","plyr","Hmisc","reshape2","varhandle")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
load("E:/Common DHS boundaries/svy_boundaries_1.RData")
View(svy_boundaries_1)
load("E:/Common DHS boundaries/svy_boundaries_2.RData")
load("E:/Common DHS boundaries/svy_boundaries_3.RData")
list.of.packages <- c("readr","Hmisc","data.table")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
wd = "E:/Common DHS boundaries"
setwd(wd)
?rbind
rbind(svy_boundaries_1,svy_boundaries_2,svy_boundaries_3)
?rbind.SpatialMultiPoints
typeof(svy_boundaries_1)
?rbind.SpatialPolygonsDataFrame
allboundaries=rbind.SpatialPolygonsDataFrame(svy_boundaries_1,svy_boundaries_2)
allboundaries=rbind.SpatialPolygonsDataFrame(allboundaries,svy_boundaries_3)
unique(allboundaries$CNTRYNAMEE)
allboundaries=rbind.SpatialPolygonsDataFrame(svy_boundaries_1,svy_boundaries_2)
allboundaries2=rbind.SpatialPolygonsDataFrame(allboundaries,svy_boundaries_3)
table(allboundaries2$CNTRYNAMEE,allboundaries2$SVYYEAR)
names(allboundaries2)
list.of.packages <- c("sp","rgdal","leaflet","data.table","mapview")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
if(.Platform$OS.type == "unix"){
prefix = "~"
}else{
prefix = "E:"
}
wd = paste0(prefix,"/git/p20_spatial_2018")
setwd(wd)
growthrates=read.csv("project_data/regionswide20180720.csv",as.is=T)
load("project_data/recent_dhs_1.RData")
dhs_growth=merge(recent_dhs_1,growthrates,by=c("OBJECTID","DHSCC"))
dhs_growth=subset(dhs_growth,!is.na(NP20HC.0))
layers=list(
"Extreme Poverty Growth Rate"="ext.growthrate"
,"P20 Growth Rate"="P20growthrate"
,"National P20 Growth Rate"="NP20growthrate"
,"Baseline P20 Headcount"="P20HC.0"
,"Baseline National P20 Headcount"="NP20HC.0"
,"Baseline Extreme Poverty Headcount"="ExtremeHC.0"
,"Latest Extreme Poverty Headcount"="ExtremeHC.1"
,"Latest P20 Headcount"="P20HC.1"
,"Latest National P20 Headcount"="NP20HC.1"
)
layernames=names(layers)
for(layername in layernames){
varname=layers[[layername]]
dhs_growth@data[,(varname)]=dhs_growth@data[,(varname),with=F][[1]]*100
pal <- colorBin(
palette = "YlOrRd",
domain = dhs_growth@data[,(varname),with=F]
,bins=quantile(dhs_growth@data[,(varname),with=F],probs=seq(0,1,0.2),na.rm=T)
)
m=leaflet(data=dhs_growth) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
setView(0, 0, zoom=2) %>%
addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2))
# ,group=layername
) %>%
addLegend("bottomright", pal=pal, values = dhs_growth@data[,(varname),with=F][[1]], opacity = 1)
filename=paste0("E:/git/p20_spatial_2018/graphics/",layername,".html")
mapshot(m,file=filename,selfcontained=F)
}
list.of.packages <- c("sp","rgdal","leaflet","data.table","mapview")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
if(.Platform$OS.type == "unix"){
prefix = "~"
}else{
prefix = "E:"
}
wd = paste0(prefix,"/git/p20_spatial_2018")
setwd(wd)
growthrates=read.csv("project_data/regionswide20180720.csv",as.is=T)
load("project_data/recent_dhs_1.RData")
dhs_growth=merge(recent_dhs_1,growthrates,by=c("OBJECTID","DHSCC"))
dhs_growth=subset(dhs_growth,!is.na(NP20HC.0))
layers=list(
"Extreme Poverty Growth Rate"="ext.growthrate"
,"P20 Growth Rate"="P20growthrate"
,"National P20 Growth Rate"="NP20growthrate"
,"Baseline P20 Headcount"="P20HC.0"
,"Baseline National P20 Headcount"="NP20HC.0"
,"Baseline Extreme Poverty Headcount"="ExtremeHC.0"
,"Latest Extreme Poverty Headcount"="ExtremeHC.1"
,"Latest P20 Headcount"="P20HC.1"
,"Latest National P20 Headcount"="NP20HC.1"
)
layernames=names(layers)
for(layername in layernames){
varname=layers[[layername]]
dhs_growth@data[,(varname)]=dhs_growth@data[,(varname),with=F][[1]]*100
pal <- colorBin(
palette = "YlOrRd",
domain = dhs_growth@data[,(varname),with=F]
,bins=quantile(dhs_growth@data[,(varname),with=F],probs=seq(0,1,0.2),na.rm=T)
)
m=leaflet(data=dhs_growth) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
setView(0, 0, zoom=2) %>%
addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2))
# ,group=layername
) %>%
addLegend("bottomright", pal=pal, values = dhs_growth@data[,(varname),with=F][[1]], opacity = 1)
filename=paste0("E:/git/p20_spatial_2018/graphics/",layername,".html")
mapshot(m,file=filename)
}
list.of.packages <- c("sp","rgdal","leaflet","data.table","mapview")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
if(.Platform$OS.type == "unix"){
prefix = "~"
}else{
prefix = "E:"
}
wd = paste0(prefix,"/git/p20_spatial_2018")
setwd(wd)
growthrates=read.csv("project_data/regionswide20180720.csv",as.is=T)
load("project_data/recent_dhs_1.RData")
dhs_growth=merge(recent_dhs_1,growthrates,by=c("OBJECTID","DHSCC"))
dhs_growth=subset(dhs_growth,!is.na(NP20HC.0))
layers=list(
"Extreme Poverty Growth Rate"="ext.growthrate"
,"P20 Growth Rate"="P20growthrate"
,"National P20 Growth Rate"="NP20growthrate"
,"Baseline P20 Headcount"="P20HC.0"
,"Baseline National P20 Headcount"="NP20HC.0"
,"Baseline Extreme Poverty Headcount"="ExtremeHC.0"
,"Latest Extreme Poverty Headcount"="ExtremeHC.1"
,"Latest P20 Headcount"="P20HC.1"
,"Latest National P20 Headcount"="NP20HC.1"
)
layernames=names(layers)
for(layername in layernames){
varname=layers[[layername]]
dhs_growth@data[,(varname)]=dhs_growth@data[,(varname),with=F][[1]]*100
pal <- colorBin(
palette = "YlOrRd",
domain = dhs_growth@data[,(varname),with=F]
,bins=quantile(dhs_growth@data[,(varname),with=F],probs=seq(0,1,0.2),na.rm=T)
)
m=leaflet(data=dhs_growth) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
setView(0, 0, zoom=2) %>%
addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2))
# ,group=layername
) %>%
addLegend("bottomright", pal=pal, values = dhs_growth@data[,(varname),with=F][[1]], opacity = 1)
filename=paste0("E:/git/p20_spatial_2018/graphics/",layername,".html")
try({mapshot(m,file=filename)})
}
list.of.packages <- c("sp","rgdal","leaflet","data.table","mapview")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
if(.Platform$OS.type == "unix"){
prefix = "~"
}else{
prefix = "E:"
}
wd = paste0(prefix,"/git/p20_spatial_2018")
setwd(wd)
growthrates=read.csv("project_data/regionswide20180720.csv",as.is=T)
load("project_data/recent_dhs_1.RData")
dhs_growth=merge(recent_dhs_1,growthrates,by=c("OBJECTID","DHSCC"))
dhs_growth=subset(dhs_growth,!is.na(NP20HC.0))
layers=list(
"Extreme Poverty Growth Rate"="ext.growthrate"
,"P20 Growth Rate"="P20growthrate"
,"National P20 Growth Rate"="NP20growthrate"
,"Baseline P20 Headcount"="P20HC.0"
,"Baseline National P20 Headcount"="NP20HC.0"
,"Baseline Extreme Poverty Headcount"="ExtremeHC.0"
,"Latest Extreme Poverty Headcount"="ExtremeHC.1"
,"Latest P20 Headcount"="P20HC.1"
,"Latest National P20 Headcount"="NP20HC.1"
)
layernames=names(layers)
for(layername in layernames){
varname=layers[[layername]]
dhs_growth@data[,(varname)]=dhs_growth@data[,(varname),with=F][[1]]*100
pal <- colorBin(
palette = "YlOrRd",
domain = dhs_growth@data[,(varname),with=F]
,bins=quantile(dhs_growth@data[,(varname),with=F],probs=seq(0,1,0.2),na.rm=T)
)
m=leaflet(data=dhs_growth) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
setView(0, 0, zoom=2)
if(grepl(".0",varname,fixed=T)){
m=m %>% addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2),"<br/>",
"<b>Year: </b>",dhs_growth@data$RequestYear.0
)
)
}  else if(grepl(".1",varname,fixed=T)){
m=m %>% addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2),"<br/>",
"<b>Year: </b>",dhs_growth@data$RequestYear.1
)
)
} else {
m=m %>% addPolygons(color = pal(dhs_growth@data[,(varname),with=F][[1]])
,fillOpacity = 1
,stroke=F
,smoothFactor=0.2
,popup=paste0(
"<b>",dhs_growth@data$CNTRYNAMEE,"</b> <br/>",
"<b>Region Name: </b>",dhs_growth@data$DHSREGEN,"<br/>",
"<b>Value: </b>",round(dhs_growth@data[,(varname),with=F][[1]],2),"<br/>",
"<b>Year Range: </b>",dhs_growth@data$RequestYear.0," - ",dhs_growth@data$RequestYear.1
)
)
}
m=m %>%  addLegend("bottomright", pal=pal, values = dhs_growth@data[,(varname),with=F][[1]], opacity = 1, title=layername)
filename=paste0("E:/git/p20_spatial_2018/graphics/",layername,".html")
try({mapshot(m,file=filename)})
}
list.of.packages <- c("data.table","readr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only=T)
wd = paste0(prefix,"/git/p20_spatial_2018")
setwd(wd)
growthrates=read.csv("project_data/regionswide20180720.csv",as.is=T)
View(growthrates)
